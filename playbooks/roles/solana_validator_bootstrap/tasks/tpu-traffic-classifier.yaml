- name: install go
  become: true
  become_user: ubuntu
  become_method: sudo
  command: wget https://go.dev/dl/go{{go_version}}.linux-amd64.tar.gz

- name: delete previous installation
  become: true
  become_user: ubuntu
  become_method: sudo
  command: rm -rf /usr/local/go

- name: extract go
  become: true
  become_user: ubuntu
  become_method: sudo
  command: tar -C /usr/local -xzf go{{go_version}}.linux-amd64.tar.gz

- name: Delete downloaded tar file
  become: true
  become_user: ubuntu
  become_method: sudo
  shell: rm -rf go{{version}}.linux-amd64.tar.gz*

- name: Add go binary path to ~/.profile
  become: true
  become_user: ubuntu
  become_method: sudo
  lineinfile:
    path: ~/.profile
    line: 'export PATH=$PATH:/usr/local/go/bin:$GOPATH/bin'
    create: true
    state: present

- name: Source updated profile
  become: true
  become_user: ubuntu
  become_method: sudo
  shell: . ~/.profile

- name: clone tpu-traffic-classifier repo
  become: true
  become_user: ubuntu
  become_method: sudo
  git:
    repo: https://github.com/rpcpool/tpu-traffic-classifier.git
    dest: /home/ubuntu/tpu-traffic-classifier
    clone: yes
    update: yes

- name: build tpu-traffic-classifier
  become: true
  become_user: ubuntu
  become_method: sudo
  shell: go build -o tpu-traffic-classifier .
  args:
    chdir: /home/ubuntu/tpu-traffic-classifier
    executable: /bin/bash

- name: copy tpu-traffic.classifier
  become: true
  become_user: ubuntu
  become_method: sudo
  copy:
    src: /home/ubuntu/tpu-traffic-classifier/tpu-traffic-classifier
    dest: /usr/local/sbin/tpu-traffic-classifier
    remote_src: true
    owner: ubuntu
    group: ubuntu
    mode: 0755

- name: Create tpu-traffic.classifier service
  become: true
  become_user: ubuntu
  become_method: sudo
  template:
    src: tpu-traffic-classifier.service.j2
    dest: /etc/systemd/system/tpu-traffic-classifier.service
    mode: 0644
    owner: root
    group: root
  tags:
    - tpu-traffic-classifier

- name: Reload systemd
  become: true
  become_user: ubuntu
  become_method: sudo
  systemd:
    daemon_reload: yes
  tags:
    - tpu-traffic-classifier

- name: Enable tpu-traffic-classifier service
  become: true
  become_user: ubuntu
  become_method: sudo
  systemd:
    name: tpu-traffic-classifier
    enabled: yes
  tags:
    - tpu-traffic-classifier
